<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoneyForge - Economic System Simulator</title>
    <style>
        :root {
            --primary: #fbbf24;
            --secondary: #3b82f6;
            --accent: #ef4444;
            --success: #10b981;
            --wealth-1: #dc2626;
            --wealth-2: #ea580c;
            --wealth-3: #d97706;
            --wealth-4: #65a30d;
            --wealth-5: #16a34a;
            --wealth-6: #059669;
            --wealth-7: #0d9488;
            --wealth-8: #0891b2;
            --wealth-9: #2563eb;
            --wealth-10: #7c3aed;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1e293b, #0f172a);
            color: #f1f5f9;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            padding: 30px 0;
            border-bottom: 2px solid var(--primary);
            margin-bottom: 30px;
            position: relative;
        }
        
        h1 {
            font-size: 3.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 30px rgba(251, 191, 36, 0.3);
        }
        
        .tagline {
            font-size: 1.2rem;
            color: #94a3b8;
            margin-bottom: 20px;
            font-style: italic;
        }
        
        .subtitle {
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 30px;
        }
        
        .control-panel {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            border: 1px solid #334155;
        }
        
        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-label {
            display: flex;
            justify-content: between;
            margin-bottom: 8px;
            font-weight: 600;
            color: #cbd5e1;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .slider-value {
            min-width: 40px;
            text-align: center;
            font-weight: bold;
            color: var(--primary);
        }
        
        input[type="range"] {
            flex: 1;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: #475569;
            border-radius: 10px;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            box-shadow: 0 0 10px rgba(251, 191, 36, 0.5);
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: var(--secondary);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        
        button.primary {
            background: var(--primary);
            color: #1e293b;
        }
        
        button.danger {
            background: var(--accent);
        }
        
        .visualization-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 1100px) {
            .visualization-area {
                grid-template-columns: 1fr;
            }
        }
        
        .viz-panel {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            border: 1px solid #334155;
            height: 400px;
            position: relative;
            overflow: hidden;
        }
        
        .viz-title {
            position: absolute;
            top: 15px;
            left: 20px;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary);
            z-index: 10;
        }
        
        .economy-canvas {
            width: 100%;
            height: 100%;
            border-radius: 10px;
        }
        
        .stats-panel {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            border: 1px solid #334155;
            margin-bottom: 30px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .stat-card {
            background: rgba(15, 23, 42, 0.7);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border-left: 4px solid var(--primary);
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin: 10px 0;
            color: var(--primary);
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #94a3b8;
        }
        
        .wealth-pyramid {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
        }
        
        .pyramid-row {
            display: flex;
            justify-content: center;
            margin-bottom: 5px;
        }
        
        .pyramid-segment {
            width: 30px;
            height: 30px;
            margin: 0 2px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 2px rgba(0, 0, 0, 0.7);
        }
        
        .scenario-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .scenario-btn {
            background: #475569;
            flex: 1;
            min-width: 120px;
        }
        
        .scenario-btn.active {
            background: var(--secondary);
        }
        
        .agent-legend {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }
        
        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 50%;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            margin-top: 30px;
            border-top: 1px solid #334155;
            color: #64748b;
            font-size: 0.9rem;
        }
        
        .wealth-1 { background-color: var(--wealth-1); }
        .wealth-2 { background-color: var(--wealth-2); }
        .wealth-3 { background-color: var(--wealth-3); }
        .wealth-4 { background-color: var(--wealth-4); }
        .wealth-5 { background-color: var(--wealth-5); }
        .wealth-6 { background-color: var(--wealth-6); }
        .wealth-7 { background-color: var(--wealth-7); }
        .wealth-8 { background-color: var(--wealth-8); }
        .wealth-9 { background-color: var(--wealth-9); }
        .wealth-10 { background-color: var(--wealth-10); }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸ’° MoneyForge</h1>
            <div class="tagline">Watch the world's most successful collective hallucination come to life</div>
            <div class="subtitle">Economic System Simulator</div>
        </header>
        
        <div class="control-panel">
            <div class="control-grid">
                <div class="control-group">
                    <div class="control-label">
                        <span>Initial Money Supply</span>
                        <span class="slider-value" id="moneySupplyValue">1000</span>
                    </div>
                    <div class="slider-container">
                        <input type="range" id="moneySupply" min="100" max="10000" value="1000" step="100" title="Initial Money Supply">
                    </div>
                </div>
                
                <div class="control-group">
                    <div class="control-label">
                        <span>Agent Greed</span>
                        <span class="slider-value" id="greedValue">0.6</span>
                    </div>
                    <div class="slider-container">
                        <input type="range" id="greed" min="0" max="1" value="0.6" step="0.05" title="Agent Greed">
                    </div>
                </div>
                
                <div class="control-group">
                    <div class="control-label">
                        <span>Risk Tolerance</span>
                        <span class="slider-value" id="riskValue">0.5</span>
                    </div>
                    <div class="slider-container">
                        <input type="range" id="risk" min="0" max="1" value="0.5" step="0.05" title="Risk Tolerance">
                    </div>
                </div>
                
                <div class="control-group">
                    <div class="control-label">
                        <span>Trust Level</span>
                        <span class="slider-value" id="trustValue">0.8</span>
                    </div>
                    <div class="slider-container">
                        <input type="range" id="trust" min="0" max="1" value="0.8" step="0.05" title="Trust Level">
                    </div>
                </div>
            </div>
            
            <div class="button-group">
                <button id="startBtn" class="primary">Start Simulation</button>
                <button id="pauseBtn">Pause</button>
                <button id="resetBtn">Reset</button>
                <button id="interveneBtn" class="danger">Economic Intervention</button>
            </div>
            
            <div class="scenario-selector">
                <button class="scenario-btn" data-scenario="invisible-hand">Invisible Hand</button>
                <button class="scenario-btn" data-scenario="hyperinflation">Hyperinflation</button>
                <button class="scenario-btn" data-scenario="depression">Great Depression</button>
                <button class="scenario-btn" data-scenario="ubi">Universal Basic Income</button>
                <button class="scenario-btn" data-scenario="crypto">Cryptocurrency</button>
                <button class="scenario-btn" data-scenario="communist">Communist Utopia</button>
            </div>
        </div>
        
        <div class="stats-panel">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Money Supply</div>
                    <div class="stat-value" id="totalMoney">$1,000,000</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Gini Coefficient</div>
                    <div class="stat-value" id="giniCoefficient">0.42</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Inflation Rate</div>
                    <div class="stat-value" id="inflationRate">2.1%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Unemployment</div>
                    <div class="stat-value" id="unemployment">4.5%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Trade Volume</div>
                    <div class="stat-value" id="tradeVolume">$125,000</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Average Wealth</div>
                    <div class="stat-value" id="avgWealth">$2,500</div>
                </div>
            </div>
            
            <div class="wealth-pyramid">
                <div class="pyramid-row">
                    <div class="pyramid-segment wealth-10">1%</div>
                </div>
                <div class="pyramid-row">
                    <div class="pyramid-segment wealth-9">4%</div>
                    <div class="pyramid-segment wealth-9">5%</div>
                </div>
                <div class="pyramid-row">
                    <div class="pyramid-segment wealth-8">10%</div>
                    <div class="pyramid-segment wealth-7">10%</div>
                    <div class="pyramid-segment wealth-6">10%</div>
                </div>
                <div class="pyramid-row">
                    <div class="pyramid-segment wealth-5">15%</div>
                    <div class="pyramid-segment wealth-4">15%</div>
                    <div class="pyramid-segment wealth-3">15%</div>
                    <div class="pyramid-segment wealth-2">10%</div>
                </div>
                <div class="pyramid-row">
                    <div class="pyramid-segment wealth-1">5%</div>
                    <div class="pyramid-segment wealth-1">5%</div>
                    <div class="pyramid-segment wealth-1">5%</div>
                    <div class="pyramid-segment wealth-1">5%</div>
                    <div class="pyramid-segment wealth-1">5%</div>
                </div>
            </div>
        </div>
        
        <div class="visualization-area">
            <div class="viz-panel">
                <div class="viz-title">Economy Canvas - Agent Activity</div>
                <canvas id="economyCanvas" class="economy-canvas"></canvas>
            </div>
            
            <div class="viz-panel">
                <div class="viz-title">Wealth Distribution</div>
                <canvas id="wealthChart" class="economy-canvas"></canvas>
            </div>
        </div>
        
        <div class="agent-legend">
            <div class="legend-item">
                <div class="legend-color" style="background-color: #dc2626;"></div>
                <span>Workers (Poor)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #d97706;"></div>
                <span>Businesses (Middle)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #16a34a;"></div>
                <span>Banks (Upper Middle)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #2563eb;"></div>
                <span>Investors (Rich)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #7c3aed;"></div>
                <span>Government (Wealthy)</span>
            </div>
        </div>
        
        <footer>
            MoneyForge - The only thing more artificial than intelligence is value.
            <br>Simulating the world's most successful collective fiction since 2023.
        </footer>
    </div>

    <script>
        // --- Session 1: Core Engine ---
        // Utility functions
        function random(min, max) {
            return Math.random() * (max - min) + min;
        }
        function generateId() {
            return Math.floor(Math.random() * 1e9);
        }

        // Agent class
        class Agent {
            constructor(type) {
                this.id = generateId();
                this.type = type; // 'worker', 'trader', 'producer'
                this.x = random(0, economyCanvas.width);
                this.y = random(0, economyCanvas.height);
                this.vx = random(-1, 1);
                this.vy = random(-1, 1);
                this.size = 10;
                // Economic properties
                this.money = 0;
                this.goods = {
                    food: Math.floor(random(0, 5)),
                    tools: Math.floor(random(0, 5)),
                    materials: Math.floor(random(0, 5))
                };
                // Skills
                this.skills = this.type === 'worker' ? ['food'] :
                              this.type === 'trader' ? [] :
                              ['tools', 'materials'];
                // Desires
                this.desires = this.randomDesires();
                // Movement
                this.target = null;
            }
            randomDesires() {
                const goods = ['food', 'tools', 'materials'];
                let desires = [];
                for (let i = 0; i < 2; i++) {
                    desires.push(goods[Math.floor(Math.random() * goods.length)]);
                }
                return desires;
            }
            move() {
                this.x += this.vx;
                this.y += this.vy;
                // Bounce off walls
                if (this.x < 0 || this.x > economyCanvas.width) this.vx *= -1;
                if (this.y < 0 || this.y > economyCanvas.height) this.vy *= -1;
                this.x = Math.max(0, Math.min(economyCanvas.width, this.x));
                this.y = Math.max(0, Math.min(economyCanvas.height, this.y));
            }
            produceGoods() {
                this.skills.forEach(skill => {
                    this.goods[skill] += Controls.production_rate;
                });
            }
            tryBarter(other) {
                // Double coincidence of wants
                const iWant = this.desires.find(d => other.goods[d] > 0);
                const theyWant = other.desires.find(d => this.goods[d] > 0);
                if (iWant && theyWant) {
                    // Exchange goods
                    this.goods[iWant]++;
                    other.goods[iWant]--;
                    other.goods[theyWant]++;
                    this.goods[theyWant]--;
                    Stats.successful_trades++;
                    return true;
                } else {
                    Stats.failed_barter_attempts++;
                    return false;
                }
            }
        }

        // --- Canvas Setup ---
        // Already set up above

        // --- Agent Population ---
    // ...existing code...
        function initializeAgents() {
            agents = [];
            for (let i = 0; i < Controls.agent_count; i++) {
                // Randomly assign type
                const types = ['worker', 'trader', 'producer'];
                const type = types[Math.floor(Math.random() * types.length)];
                agents.push(new Agent(type));
            }
        }

        // --- Animation Loop ---
        function coreEngineStep() {
            // Move agents
            agents.forEach(agent => {
                agent.move();
                agent.produceGoods();
            });
            // Barter attempts
            for (let i = 0; i < agents.length; i++) {
                for (let j = i + 1; j < agents.length; j++) {
                    // If close enough, try to barter
                    const a = agents[i], b = agents[j];
                    const dist = Math.hypot(a.x - b.x, a.y - b.y);
                    if (dist < 30) {
                        a.tryBarter(b);
                    }
                }
            }
            drawEconomy();
            updateStats();
        }

        // --- Main Animation ---
        function runCoreEngine() {
            coreEngineStep();
            requestAnimationFrame(runCoreEngine);
        }

        // --- Start Core Engine on Load ---
        window.addEventListener('load', () => {
            initializeAgents();
            runCoreEngine();
        });
        // --- Stats Object ---
        const Stats = {
            total_agents: 100,
            total_trades: 0,
            successful_trades: 0,
            failed_barter_attempts: 0,
            currency_adoption: 0,
            money_supply: 0,
            gini_coefficient: 0,
            avg_wealth: 0,
            median_wealth: 0,
            price_index: {},
            inflation_rate: 0
        };
            // --- Controls Object ---
            const Controls = {
                speed: 1.0,
                agent_count: 100,
                production_rate: 0.5,
                consumption_rate: 0.3,
                enable_money: true,
                money_seeding: 0,
                print_money: function() {
                    agents.forEach(agent => agent.money += 100);
                    updateStats();
                },
                reset: function() {
                    simulationRunning = false;
                    if (animationId) cancelAnimationFrame(animationId);
                    time = 0;
                    transactions = [];
                    initializeAgents();
                    drawEconomy();
                    drawWealthChart();
                    updateStats();
                },
                introduce_bank: function() {
                    // Add a bank agent
                    agents.push({
                        id: agents.length,
                        type: 'BANK',
                        x: Math.random() * economyCanvas.width,
                        y: Math.random() * economyCanvas.height,
                        vx: (Math.random() - 0.5) * 2,
                        vy: (Math.random() - 0.5) * 2,
                        money: 5000,
                        color: '#16a34a',
                        size: 15,
                        wealthHistory: []
                    });
                    drawEconomy();
                    updateStats();
                },
                preset_barter: function() {
                    Controls.enable_money = false;
                    agents.forEach(agent => agent.money = 0);
                    updateStats();
                },
                preset_money: function() {
                    Controls.enable_money = true;
                    agents.forEach(agent => agent.money = Math.random() < 0.5 ? 100 : 0);
                    updateStats();
                },
                preset_crash: function() {
                    agents.forEach(agent => agent.money *= 0.1);
                    updateStats();
                }
            };

        // Canvas setup
        const economyCanvas = document.getElementById('economyCanvas');
        const wealthChart = document.getElementById('wealthChart');
        const ctx = economyCanvas.getContext('2d');
        const wealthCtx = wealthChart.getContext('2d');
        
        // Set canvas dimensions
        function resizeCanvases() {
            economyCanvas.width = economyCanvas.offsetWidth;
            economyCanvas.height = economyCanvas.offsetHeight;
            wealthChart.width = wealthChart.offsetWidth;
            wealthChart.height = wealthChart.offsetHeight;
        }
        
        window.addEventListener('resize', resizeCanvases);
        resizeCanvases();
        
        // Simulation state
        let simulationRunning = false;
        let animationId = null;
    // ...existing code...
        let transactions = [];
        let moneySupply = 1000;
        let time = 0;
        
        // Agent types
        const AGENT_TYPES = {
            WORKER: { color: '#dc2626', size: 8, count: 60 },
            BUSINESS: { color: '#d97706', size: 12, count: 20 },
            BANK: { color: '#16a34a', size: 15, count: 5 },
            INVESTOR: { color: '#2563eb', size: 18, count: 10 },
            GOVERNMENT: { color: '#7c3aed', size: 22, count: 5 }
        };
        
        // Initialize agents
        function initializeAgents() {
            agents = [];
            let id = 0;
            
            // Create agents for each type
            for (const [type, config] of Object.entries(AGENT_TYPES)) {
                for (let i = 0; i < config.count; i++) {
                    const wealthMultiplier = type === 'WORKER' ? 0.5 : 
                                           type === 'BUSINESS' ? 2 : 
                                           type === 'BANK' ? 10 : 
                                           type === 'INVESTOR' ? 20 : 50;
                    
                    agents.push({
                        id: id++,
                        type: type,
                        x: Math.random() * economyCanvas.width,
                        y: Math.random() * economyCanvas.height,
                        vx: (Math.random() - 0.5) * 2,
                        vy: (Math.random() - 0.5) * 2,
                        money: Math.max(100, Math.random() * 500 * wealthMultiplier),
                        color: config.color,
                        size: config.size,
                        wealthHistory: []
                    });
                }
            }
            
            // Initialize wealth history
            agents.forEach(agent => {
                for (let i = 0; i < 100; i++) {
                    agent.wealthHistory.push(agent.money);
                }
            });
        }
        
        // Update simulation stats
        function updateStats() {
            const totalMoney = agents.reduce((sum, agent) => sum + agent.money, 0);
            const avgWealth = totalMoney / agents.length;
            
            // Calculate Gini coefficient (simplified)
            const sortedWealth = agents.map(a => a.money).sort((a, b) => a - b);
            const n = agents.length;
            let giniSum = 0;
            
            for (let i = 0; i < n; i++) {
                for (let j = 0; j < n; j++) {
                    giniSum += Math.abs(sortedWealth[i] - sortedWealth[j]);
                }
            }
            
            const gini = giniSum / (2 * n * n * avgWealth);
            
            // Update DOM
            document.getElementById('totalMoney').textContent = `$${Math.round(totalMoney).toLocaleString()}`;
            document.getElementById('giniCoefficient').textContent = gini.toFixed(3);
            document.getElementById('inflationRate').textContent = `${(Math.sin(time/100) * 5 + 2).toFixed(1)}%`;
            document.getElementById('unemployment').textContent = `${(Math.sin(time/50) * 2 + 5).toFixed(1)}%`;
            document.getElementById('tradeVolume').textContent = `$${Math.round(Math.random() * 50000 + 100000).toLocaleString()}`;
            document.getElementById('avgWealth').textContent = `$${Math.round(avgWealth).toLocaleString()}`;
        }
        
        // Draw economy canvas
        function drawEconomy() {
            ctx.clearRect(0, 0, economyCanvas.width, economyCanvas.height);
            
            // Draw transactions
            ctx.strokeStyle = 'rgba(251, 191, 36, 0.3)';
            ctx.lineWidth = 1;
            
            transactions.forEach(transaction => {
                ctx.beginPath();
                ctx.moveTo(transaction.from.x, transaction.from.y);
                ctx.lineTo(transaction.to.x, transaction.to.y);
                ctx.stroke();
            });
            
            // Draw agents
            agents.forEach(agent => {
                ctx.beginPath();
                ctx.arc(agent.x, agent.y, agent.size, 0, Math.PI * 2);
                ctx.fillStyle = agent.color;
                ctx.fill();
                
                // Add glow effect for wealthy agents
                if (agent.money > 1000) {
                    ctx.shadowColor = agent.color;
                    ctx.shadowBlur = 15;
                    ctx.fill();
                    ctx.shadowBlur = 0;
                }
                
                // Draw money indicator
                ctx.fillStyle = 'white';
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`$${Math.round(agent.money)}`, agent.x, agent.y + agent.size + 15);
            });
            
            // Limit transactions history
            if (transactions.length > 50) {
                transactions = transactions.slice(-50);
            }
        }
        
        // Draw wealth distribution chart
        function drawWealthChart() {
            wealthCtx.clearRect(0, 0, wealthChart.width, wealthChart.height);
            
            // Sort agents by wealth
            const sortedAgents = [...agents].sort((a, b) => a.money - b.money);
            const barWidth = wealthChart.width / sortedAgents.length;
            
            // Find max wealth for scaling
            const maxWealth = Math.max(...sortedAgents.map(a => a.money));
            
            // Draw bars
            sortedAgents.forEach((agent, i) => {
                const barHeight = (agent.money / maxWealth) * (wealthChart.height - 40);
                const x = i * barWidth;
                const y = wealthChart.height - barHeight;
                
                wealthCtx.fillStyle = agent.color;
                wealthCtx.fillRect(x, y, barWidth - 1, barHeight);
            });
            
            // Draw labels
            wealthCtx.fillStyle = 'white';
            wealthCtx.font = '12px Arial';
            wealthCtx.textAlign = 'center';
            wealthCtx.fillText('Wealth Distribution (Poorest â†’ Richest)', wealthChart.width / 2, wealthChart.height - 10);
        }
        
        // Update agent positions and simulate interactions
        function updateAgents() {
            // Move agents
            agents.forEach(agent => {
                agent.x += agent.vx;
                agent.y += agent.vy;
                
                // Bounce off walls
                if (agent.x < 0 || agent.x > economyCanvas.width) agent.vx *= -1;
                if (agent.y < 0 || agent.y > economyCanvas.height) agent.vy *= -1;
                
                // Keep within bounds
                agent.x = Math.max(0, Math.min(economyCanvas.width, agent.x));
                agent.y = Math.max(0, Math.min(economyCanvas.height, agent.y));
                
                // Update wealth history
                agent.wealthHistory.push(agent.money);
                if (agent.wealthHistory.length > 100) {
                    agent.wealthHistory.shift();
                }
            });
            
            // Simulate random transactions
            if (Math.random() < 0.3) {
                const fromIndex = Math.floor(Math.random() * agents.length);
                const toIndex = Math.floor(Math.random() * agents.length);
                
                if (fromIndex !== toIndex) {
                    const fromAgent = agents[fromIndex];
                    const toAgent = agents[toIndex];
                    
                    // Only transfer money if the sender has enough
                    const amount = Math.min(fromAgent.money * 0.1, 100);
                    
                    if (amount > 1 && fromAgent.money > amount) {
                        fromAgent.money -= amount;
                        toAgent.money += amount;
                        
                        // Record transaction for visualization
                        transactions.push({
                            from: { x: fromAgent.x, y: fromAgent.y },
                            to: { x: toAgent.x, y: toAgent.y },
                            amount: amount,
                            age: 0
                        });
                    }
                }
            }
            
            // Age transactions
            transactions.forEach(t => t.age++);
        }
        
        // Main simulation loop
        function simulate() {
            if (!simulationRunning) return;
            
            time++;
            updateAgents();
            drawEconomy();
            drawWealthChart();
            updateStats();
            
            animationId = requestAnimationFrame(simulate);
        }
        
        // Initialize simulation
        function init() {
            initializeAgents();
            drawEconomy();
            drawWealthChart();
            updateStats();

            // Set up event listeners for sliders
            document.getElementById('moneySupply').addEventListener('input', function() {
                document.getElementById('moneySupplyValue').textContent = this.value;
                moneySupply = parseInt(this.value);
            });
            document.getElementById('greed').addEventListener('input', function() {
                document.getElementById('greedValue').textContent = this.value;
            });
            document.getElementById('risk').addEventListener('input', function() {
                document.getElementById('riskValue').textContent = this.value;
            });
            document.getElementById('trust').addEventListener('input', function() {
                document.getElementById('trustValue').textContent = this.value;
            });

            // Simulation speed control (example, add slider in UI if needed)
            // Controls.speed = ...

            // Agent count control (example, add slider in UI if needed)
            // Controls.agent_count = ...

            // Economy settings (production/consumption rates)
            // Controls.production_rate = ...
            // Controls.consumption_rate = ...

            // Money settings
            // Controls.enable_money = ...
            // Controls.money_seeding = ...

            // Set up control buttons
            document.getElementById('startBtn').addEventListener('click', function() {
                if (!simulationRunning) {
                    simulationRunning = true;
                    simulate();
                }
            });
            document.getElementById('pauseBtn').addEventListener('click', function() {
                simulationRunning = false;
                if (animationId) {
                    cancelAnimationFrame(animationId);
                }
            });
            document.getElementById('resetBtn').addEventListener('click', Controls.reset);
            document.getElementById('interveneBtn').addEventListener('click', Controls.print_money);

            // Example: Add banking system button (if you add to UI)
            // document.getElementById('bankBtn').addEventListener('click', Controls.introduce_bank);

            // Set up scenario buttons
            document.querySelectorAll('.scenario-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.scenario-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    const scenario = this.dataset.scenario;
                    if (scenario === 'invisible-hand') Controls.preset_barter();
                    else if (scenario === 'hyperinflation') Controls.preset_money();
                    else if (scenario === 'depression') Controls.preset_crash();
                    else if (scenario === 'ubi') Controls.print_money();
                    else if (scenario === 'crypto') Controls.introduce_bank();
                    else if (scenario === 'communist') {
                        // Wealth redistribution - everyone gets the same
                        Stats.total_agents = agents.length;
                        Stats.money_supply = agents.reduce((sum, agent) => sum + agent.money, 0);
                        Stats.avg_wealth = Stats.money_supply / Stats.total_agents;
                        // Median wealth
                        const sortedWealth = agents.map(a => a.money).sort((a, b) => a - b);
                        if (Stats.total_agents % 2 === 0) {
                            Stats.median_wealth = (sortedWealth[Stats.total_agents/2 - 1] + sortedWealth[Stats.total_agents/2]) / 2;
                        } else {
                            Stats.median_wealth = sortedWealth[Math.floor(Stats.total_agents/2)];
                        }
                        // Gini coefficient (simplified)
                        let giniSum = 0;
                        for (let i = 0; i < Stats.total_agents; i++) {
                            for (let j = 0; j < Stats.total_agents; j++) {
                                giniSum += Math.abs(sortedWealth[i] - sortedWealth[j]);
                            }
                        }
                        Stats.gini_coefficient = giniSum / (2 * Stats.total_agents * Stats.total_agents * Stats.avg_wealth);
                        // Inflation rate (placeholder)
                        Stats.inflation_rate = (Math.sin(time/100) * 5 + 2).toFixed(1);
                        // Currency adoption (placeholder: % agents with money > 0)
                        Stats.currency_adoption = Math.round(100 * agents.filter(a => a.money > 0).length / Stats.total_agents);
                        // Update DOM
                        document.getElementById('totalMoney').textContent = `$${Math.round(Stats.money_supply).toLocaleString()}`;
                        document.getElementById('giniCoefficient').textContent = Stats.gini_coefficient.toFixed(3);
                        document.getElementById('inflationRate').textContent = `${Stats.inflation_rate}%`;
                        document.getElementById('unemployment').textContent = `${(Math.sin(time/50) * 2 + 5).toFixed(1)}%`;
                        document.getElementById('tradeVolume').textContent = `$${Math.round(Math.random() * 50000 + 100000).toLocaleString()}`;
                        document.getElementById('avgWealth').textContent = `$${Math.round(Stats.avg_wealth).toLocaleString()}`;
                        // Optionally display more stats in the UI
                    } // <-- Add this closing brace to end the event handler function

                    time = 0;
                    transactions = [];
                    initializeAgents();
                    
                    // Apply scenario-specific modifications
                    switch(scenario) {
                        case 'invisible-hand':
                            // Free market - minimal intervention
                            document.getElementById('greed').value = 0.8;
                            document.getElementById('risk').value = 0.7;
                            document.getElementById('greedValue').textContent = '0.8';
                            document.getElementById('riskValue').textContent = '0.7';
                            break;
                            
                        case 'hyperinflation':
                            // Print massive amounts of money
                            agents.forEach(agent => {
                                agent.money *= 10;
                            });
                            break;
                            
                        case 'depression':
                            // Credit freeze and wealth destruction
                            agents.forEach(agent => {
                                if (agent.type === 'BANK') {
                                    agent.money *= 0.5; // Banks lose money
                                } else {
                                    agent.money *= 0.7; // Everyone loses wealth
                                }
                            });
                            break;
                            
                        case 'ubi':
                            // Universal Basic Income
                            agents.forEach(agent => {
                                agent.money += 200; // Give everyone money
                            });
                            break;
                            
                        case 'crypto':
                            // Introduce cryptocurrency - create new wealthy class
                            for (let i = 0; i < 5; i++) {
                                agents.push({
                                    id: agents.length,
                                    type: 'INVESTOR',
                                    x: Math.random() * economyCanvas.width,
                                    y: Math.random() * economyCanvas.height,
                                    vx: (Math.random() - 0.5) * 2,
                                    vy: (Math.random() - 0.5) * 2,
                                    money: 10000, // Crypto millionaires
                                    color: '#7c3aed',
                                    size: 20,
                                    wealthHistory: []
                                });
                            }
                            break;
                            
                        case 'communist':
                            // Wealth redistribution - everyone gets the same
                            const totalWealth = agents.reduce((sum, agent) => sum + agent.money, 0);
                            const equalShare = totalWealth / agents.length;
                            
                            agents.forEach(agent => {
                                agent.money = equalShare;
                            });
                            break;
                    }
                    
                    drawEconomy();
                    drawWealthChart();
                    updateStats();
                }); // <-- End of scenario button event handler

            // Start everything when page loads
            window.addEventListener('load', init);
    </script>
</body>
</html>
